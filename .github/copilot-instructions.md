# Copilot Project Instructions

- Stack: Flask app factory with SQLAlchemy/Flask-Migrate + Flask-Login; SQLite DB lives at `app/database.db`. Entry script runs the factory in [run.py](run.py#L1-L4); the factory wires DB, login manager, and blueprints in [app/__init__.py](app/__init__.py#L13-L48).
- Blueprints: auth, problem, test_case, submission, ranking, admin are all registered in [app/__init__.py](app/__init__.py#L37-L42). Add new routes via blueprints rather than a monolithic `app.py`.
- Models: `User`/`Problem`/`Submission`/`TestCase` are simple SQLAlchemy models defined in [app/models](app/models). Relationships are declared on `Problem` and `Submission`; `User` implements the Flask-Login interface but stores `is_admin` for role checks ([app/models/user.py](app/models/user.py#L1-L34), [app/models/problem.py](app/models/problem.py#L1-L15), [app/models/submission.py](app/models/submission.py#L1-L27), [app/models/test_case.py](app/models/test_case.py#L1-L9)).
- Auth flow: registration/login/logout are in [app/controller/auth_controller.py](app/controller/auth_controller.py#L1-L69) and use `create_user`/`check_password` from [app/service/auth_service.py](app/service/auth_service.py#L1-L24). `login_user` is called, but user id lookups elsewhere rely on `session['user_id']`; if you change auth, keep session availability consistent or update downstream consumers.
- Problems: creation/list/search/delete handled in [app/controller/problem_controller.py](app/controller/problem_controller.py#L1-L83) with persistence in [app/service/problem_service.py](app/service/problem_service.py#L1-L34). Basic form validation lives in the controller; services assume validated input.
- Test cases: CRUD is limited to create/list in [app/controller/test_case_controller.py](app/controller/test_case_controller.py#L1-L44) and [app/service/test_case_service.py](app/service/test_case_service.py#L1-L20); `create_test_case` raises `ValueError` when the problem is missing.
- Submissions/judging: submissions are created and executed synchronously in [app/service/submission_service.py](app/service/submission_service.py#L9-L73). Each test case runs via `run_python`; on TLE/runtime error the loop short-circuits and status/stderr/stdout are saved. AC/WA determination uses `judge` (line-normalized diff) in [app/service/judge.py](app/service/judge.py#L1-L34).
- Code execution: `run_python` writes code to a temp dir, mounts it into a Docker container, and runs image `juiz-python` with a 5s timeout ([app/service/runner/python_runner.py](app/service/runner/python_runner.py#L1-L37)). Build the image once with `docker build -t juiz-python docker/python` before running submissions; Docker must be available to the app.
- Admin access: protected by `admin_required` decorator (checks `current_user.is_admin`) combined with `login_required` ([app/utils/decorators.py](app/utils/decorators.py#L1-L14)). Admin blueprint routes live under `/admin` ([app/controller/admin_controller.py](app/controller/admin_controller.py#L1-L16)).
- Ranking: uses `User.points` ordering in [app/service/ranking_service.py](app/service/ranking_service.py#L1-L4) and renders via [app/controller/ranking_controller.py](app/controller/ranking_controller.py#L1-L10). Points are not updated elsewhere yet.
- Templates/static: Jinja templates in [templates/](templates) and assets in [static/](static); keep naming consistent with controller renderings (e.g., `create_problem.html`, `problem_detail.html`).
- DB setup & migrations: SQLAlchemy/Migrate initialized in [app/service/database.py](app/service/database.py#L1-L4). Typical workflow: set `FLASK_APP=run.py`, run `flask db upgrade` to apply migrations. SQLite path is derived from `app/__init__.py` `BASE_DIR`.
- Running locally: install `requirements.txt`, ensure Docker image `juiz-python` is built, then start with `python run.py` (debug enabled). The root route renders `home.html`.
- Conventions: thin controllers with form validation + flash messaging; services own DB writes/commits. Errors for missing entities are raised as `ValueError` in services; controllers convert to flash+redirect.
- Tests: `tests/` exists but files are empty; add pytest-based tests under that folder. If you add fixtures, prefer using the app factory pattern for test clients.
